{% extends 'core/base.html' %}
{% block nav_user_active %}active{% endblock %}
{% load static %} 
{% block title %}Hồ sơ - LapStore{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/css/profile.css' %}">
{% endblock %}
{% block content %}
<div class="breadcrumb">
  <a href="{% url 'core:home' %}">Trang chủ</a>
</div>
    <div class="profile-page">
      <div class="container">
        <div class="main-container">
        <aside class="sidebar-left">
            <div class="profile-snippet">
                
                <img src="{{ avatar }}" alt="Avatar">
                
                <h3>{{ first_name }} {{last_name}}</h3>
               
            </div>
            <div class="nav-menu">
                <a href="#" class="nav-item-profile active"><i class="fas fa-user-shield"></i> Thông tin cá nhân</a>
                <a href="{% url "users:order_list" %}" class="nav-item-profile"><i class="fas fa-box-open"></i> Đơn hàng của tôi</a>
                <a href="#" class="nav-item-profile"><i class="fas fa-wallet"></i> Ví thanh toán</a>
                <a href="{% url 'users:logout' %}" class="nav-item-profile" id='logout'><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
            </div>
        </aside>
                <script> 
                    const logoutBtn = document.getElementById('logout');
                    logoutBtn.addEventListener('click', function(event) {
                        event.preventDefault(); 
                        const confirmed = confirm("Bạn có chắc chắn muốn đăng xuất không?");
                        if (confirmed) {
                            window.location.href = logoutBtn.href; 
                        }
                    });

                </script>

        <main class="content-card">
            <h2 class="section-title">Cài đặt tài khoản</h2>
            <p class="section-subtitle">Thay đổi thông tin liên hệ và tùy chỉnh bảo mật tài khoản của bạn.</p>

            <form method="post" action="">
              {% csrf_token %}
                <div class="info-grid">
                    <div class="input-group">
                        <label>Họ và tên</label>
                        <input type="text" name="first_name" value="{{ first_name }}">
                    </div>
                    <div class="input-group">
                        <label>Tên</label>
                        <input type="text" name="last_name" value="{{ last_name|default:'' }}">
                    </div>
                     <div class="input-group">
                        <label>Số điện thoại</label>
                        <input type="tel" name="phone_number" value="{{phone_number|default:''}}">
                    </div> 
                    <div class="input-group">
                        <label>Địa chỉ Email</label>
                        <input type="email" value="{{ email }}" disabled style="background: #f8f9fa; cursor: not-allowed;">
                    </div>
                    <div class="form-row full-row">
                        <div class="input-group">
                            <label>Tỉnh / Thành phố</label>
                            <select class="form-control" name="province" id="province"></select>
                        </div>
                        <div class="input-group">
                            <label>Quận / Huyện</label>
                            <select class="form-control" name="district" id="district"></select>
                        </div>
                        <div class="input-group">
                            <label>Phường / Xã</label>
                            <select class="form-control" name="ward" id="ward"></select>
                        </div>
                    </div>
                    <div class="input-group full-row">
                        <label>Địa chỉ cụ thể (Số nhà, tên đường)</label>
                        <input type="text" name="street_address" placeholder="Nhập số nhà, tên đường..." value="{{ default_address.street_address|default:'' }}">
                    </div>
                </div>

                <button type="submit" class="btn-submit">CẬP NHẬT HỒ SƠ</button>
            </form>
          </main>
        </div>
      </div>
    </div>
  
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const provinceSelect = document.getElementById("province");
    const districtSelect = document.getElementById("district");
    const wardSelect = document.getElementById("ward");
    const apiHost = "https://provinces.open-api.vn/api/";

    // Hàm để render options cho select
    function renderOptions(selectElement, data, defaultText, selectedCode) {
      selectElement.innerHTML = `<option value="">${defaultText}</option>`;
      data.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.code;
        option.textContent = item.name;
        if (item.code == selectedCode) {
            option.selected = true;
        }
        selectElement.appendChild(option);
      });
    }

    // Lấy danh sách tỉnh/thành phố
    fetch(apiHost + "?depth=1")
      .then((response) => response.json())
      .then((data) => {
        renderOptions(provinceSelect, data, "Chọn Tỉnh/Thành", "{{ default_address.province_code|default:'' }}");
        if (provinceSelect.value) {
            provinceSelect.dispatchEvent(new Event('change'));
        }
      });

    // Xử lý khi chọn tỉnh/thành phố
    provinceSelect.addEventListener("change", function () {
      const provinceCode = this.value;
      districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
      wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

      if (provinceCode) {
        fetch(apiHost + `p/${provinceCode}?depth=2`)
          .then((response) => response.json())
          .then((data) => {
            renderOptions(districtSelect, data.districts, "Chọn Quận/Huyện", "{{ default_address.district_code|default:'' }}");
            if (districtSelect.value) {
                districtSelect.dispatchEvent(new Event('change'));
            }
          });
      }
    });

    // Xử lý khi chọn quận/huyện
    districtSelect.addEventListener("change", function () {
      const districtCode = this.value;
      wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

      if (districtCode) {
        fetch(apiHost + `d/${districtCode}?depth=2`)
          .then((response) => response.json())
          .then((data) => {
            renderOptions(wardSelect, data.wards, "Chọn Phường/Xã", "{{ default_address.ward_code|default:'' }}");
          });
      }
    });
  });
</script>
{% endblock %}