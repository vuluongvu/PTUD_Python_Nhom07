{% extends 'core/base.html' %} {% load static %} {% load humanize %} {% block title %}Thanh toán -
LapStore{% endblock %} {% block extra_css %}{% endblock %}
{% block mobile_menu %}{% endblock %} 

{% block content %}

<div style="margin-top: -10px; margin-bottom: 20px">
  <p style="font-size: 13px; color: var(--text-sub)">
    <a href="{% url 'core:home' %}">Trang chủ</a>
    <i
      class="fa-solid fa-chevron-right"
      style="font-size: 10px; margin: 0 5px"
    ></i>
    <a href="{% url 'orders:cart' %}">Giỏ hàng</a>
    <i
      class="fa-solid fa-chevron-right"
      style="font-size: 10px; margin: 0 5px"
    ></i>
    Thanh toán
  </p>
</div>

<form id="checkoutForm" class="checkout-form" method="POST">
  {% csrf_token %}
  <div class="checkout-layout">
    <!-- Cột trái: Thông tin giao hàng -->
    <div class="checkout-col-left">
      <div class="content-block">
        <h3 class="block-title">
          <i class="fa-solid fa-location-dot"></i> Thông tin giao hàng
        </h3>
        
          <div class="form-row">
            <div class="form-group">
              <label>Họ và tên <span style="color: red">*</span></label>
              <input
                type="text"
                class="form-control"
                name="fullname"
                placeholder="Nhập họ tên của bạn"
                required
              />
            </div>
            <div class="form-group">
              <label>Số điện thoại <span style="color: red">*</span></label>
              <input
                type="tel"
                class="form-control"
                name="phone"
                placeholder="Nhập số điện thoại"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label>Email (Để nhận hóa đơn)</label>
            <input
              type="email"
              class="form-control"
              name="email"
              placeholder="Nhập email của bạn"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Tỉnh / Thành phố <span style="color: red">*</span></label>
              <select class="form-control" name="province" id="province" required>
                <option value="">Chọn Tỉnh/Thành</option>
              </select>
            </div>
            <div class="form-group">
              <label>Quận / Huyện <span style="color: red">*</span></label>
              <select class="form-control" name="district" id="district" required>
                <option value="">Chọn Quận/Huyện</option>
              </select>
            </div>
            <div class="form-group">
              <label>Phường / Xã <span style="color: red">*</span></label>
              <select class="form-control" name="ward" id="ward" required>
                <option value="">Chọn Phường/Xã</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Địa chỉ cụ thể <span style="color: red">*</span></label>
            <input
              type="text"
              class="form-control"
              name="address"
              placeholder="Số nhà, tên đường..."
              required
            />
          </div>

          <div class="form-group">
            <label>Ghi chú đơn hàng</label>
            <textarea
              class="form-control"
              name="note"
              rows="3"
              placeholder="Ví dụ: Giao hàng giờ hành chính..."
            ></textarea>
          </div>
      </div>

      <div class="content-block" style="margin-top: 20px">
        <h3 class="block-title">
          <i class="fa-regular fa-credit-card"></i> Phương thức thanh toán
        </h3>
        <div class="payment-methods">
          <label class="payment-option active">
            <input type="radio" name="payment" value="cod" checked />
            <div class="payment-info">
              <span class="payment-name">Thanh toán khi nhận hàng (COD)</span>
              <span class="payment-desc"
                >Bạn chỉ phải thanh toán khi đã nhận được hàng.</span
              >
            </div>
            <i
              class="fa-solid fa-money-bill-wave"
              style="font-size: 24px; color: var(--primary)"
            ></i>
          </label>

          <label class="payment-option">
            <input type="radio" name="payment" value="banking" />
            <div class="payment-info">
              <span class="payment-name">Chuyển khoản ngân hàng</span>
              <span class="payment-desc"
                >Giảm ngay 1% tối đa 100k khi chuyển khoản trước.</span
              >
            </div>
            <i
              class="fa-solid fa-building-columns"
              style="font-size: 24px; color: #1877f2"
            ></i>
          </label>

          <label class="payment-option">
            <input type="radio" name="payment" value="card" />
            <div class="payment-info">
              <span class="payment-name">Thẻ ATM / Visa / MasterCard</span>
              <span class="payment-desc"
                >Thanh toán an toàn qua cổng VNPAY/Momo.</span
              >
            </div>
            <i
              class="fa-regular fa-credit-card"
              style="font-size: 24px; color: #fcd34d"
            ></i>
          </label>
        </div>
      </div>
    </div>

    <!-- Cột phải: Tóm tắt đơn hàng -->
    <div class="checkout-col-right">
      <div class="order-summary" style="position: sticky; top: 100px"> <h3 class="block-title"> Đơn hàng ({{ product_count }} sản phẩm) </h3>
        <div class="checkout-items">
          {% for item in cart_items %}
            <div class="c-item">
              <div class="c-img">
                <img
                  src="{% if item.product.images.first %}{{ item.product.images.first.image_url }}{% else %}{% static 'core/img/placeholder.png' %}{% endif %}"
                  alt="{{ item.product.name }}"
                />
                <span class="c-qty">{{ item.quantity }}</span>
              </div>
              <div class="c-info">
                <div class="c-name">{{ item.product.name }}</div>
                <div class="c-price">{{ item.product.final_price|floatformat:0|intcomma }}đ</div>
              </div>
            </div>
          {% endfor %}
        </div>

        <div class="coupon-box">
          <input type="text" class="coupon-input" placeholder="Mã giảm giá" />
          <button class="btn-apply">Áp dụng</button>
        </div>

        <div class="summary-row">
          <span>Tạm tính</span>
          <span>{{ total_amount|floatformat:0|intcomma }}đ</span>
        </div>
        <div class="summary-row">
          <span>Phí vận chuyển</span>
          <span>Miễn phí</span>
        </div>
        <div class="summary-row">
          <span>Giảm giá</span>
          <span style="color: #22c55e">-0đ</span>
        </div>

        <div class="summary-row total">
          <span>Tổng cộng</span>
          <span class="total-price-big">{{ total_amount|floatformat:0|intcomma }}đ</span>
        </div>

        <button type="submit" class="btn-checkout">
          ĐẶT HÀNG
        </button>
        <p
          style="
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
            color: #6b7280;
          "
        >
          Bằng việc đặt hàng, bạn đồng ý với
          <a href="#" style="color: var(--primary)">Điều khoản sử dụng</a> của
          chúng tôi.
        </p>
      </div>
    </div>
  </div>
</form>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const provinceSelect = document.getElementById("province");
    const districtSelect = document.getElementById("district");
    const wardSelect = document.getElementById("ward");
    const apiHost = "https://provinces.open-api.vn/api/";

    // Hàm để render options cho select
    function renderOptions(selectElement, data, defaultText) {
      selectElement.innerHTML = `<option value="">${defaultText}</option>`;
      data.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.code;
        option.textContent = item.name;
        selectElement.appendChild(option);
      });
    }

    // Lấy danh sách tỉnh/thành phố
    fetch(apiHost + "?depth=1")
      .then((response) => response.json())
      .then((data) => {
        renderOptions(provinceSelect, data, "Chọn Tỉnh/Thành");
      });

    // Xử lý khi chọn tỉnh/thành phố
    provinceSelect.addEventListener("change", function () {
      const provinceCode = this.value;
      districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
      wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

      if (provinceCode) {
        fetch(apiHost + `p/${provinceCode}?depth=2`)
          .then((response) => response.json())
          .then((data) => {
            renderOptions(districtSelect, data.districts, "Chọn Quận/Huyện");
          });
      }
    });

    // Xử lý khi chọn quận/huyện
    districtSelect.addEventListener("change", function () {
      const districtCode = this.value;
      wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

      if (districtCode) {
        fetch(apiHost + `d/${districtCode}?depth=2`)
          .then((response) => response.json())
          .then((data) => {
            renderOptions(wardSelect, data.wards, "Chọn Phường/Xã");
          });
      }
    });

    // Ghi lại tên text của địa chỉ vào hidden input trước khi submit
    const checkoutForm = document.getElementById("checkoutForm");
    checkoutForm.addEventListener("submit", function () {
      const provinceText = provinceSelect.options[provinceSelect.selectedIndex].text;
      const districtText = districtSelect.options[districtSelect.selectedIndex].text;
      const wardText = wardSelect.options[wardSelect.selectedIndex].text;

      // Tạo các input ẩn để gửi tên text lên server
      if (provinceText && provinceText !== "Chọn Tỉnh/Thành")
        checkoutForm.insertAdjacentHTML('beforeend', `<input type="hidden" name="province_text" value="${provinceText}">`);
      if (districtText && districtText !== "Chọn Quận/Huyện")
        checkoutForm.insertAdjacentHTML('beforeend', `<input type="hidden" name="district_text" value="${districtText}">`);
      if (wardText && wardText !== "Chọn Phường/Xã")
        checkoutForm.insertAdjacentHTML('beforeend', `<input type="hidden" name="ward_text" value="${wardText}">`);
    });

  });
</script>
{% endblock %}
