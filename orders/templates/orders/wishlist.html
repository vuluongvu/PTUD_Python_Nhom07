{% extends 'core/base.html' %} {% load static %} {% block title %}Danh sách yêu
thích - LapStore{% endblock %} {% block extra_css %}
<style>
  /* Style riêng cho nút xóa trong wishlist */
  .btn-remove-wish {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ef4444;
    cursor: pointer;
    z-index: 5;
    border: 1px solid #fee2e2;
    transition: all 0.2s;
  }
  .btn-remove-wish:hover {
    background: #ef4444;
    color: white;
    transform: scale(1.1);
  }
</style>

{% endblock %} {% block content %}
<div style="margin-top: -10px; margin-bottom: 20px">
  <p style="font-size: 13px; color: var(--text-sub)">
    <a href="{% url 'core:home' %}">Trang chủ</a>
    <i
      class="fa-solid fa-chevron-right"
      style="font-size: 10px; margin: 0 5px"
    ></i>
    Danh sách yêu thích
  </p>
</div>

<div class="section-head">
  <h2 style="font-size: 24px; font-weight: 800">
    Sản phẩm <span style="color: var(--primary)">Yêu thích</span> (3)
  </h2>
</div>

<div class="flash-grid">
  <!-- DJANGO: Loop Wishlist Items -->
  <!-- Sản phẩm -->
  {% for item in wishlist %}
  <article class="prod-card" id="wishlist-item-{{ item.product.id }}">
    <button class="btn-remove-wish" 
            title="Xóa khỏi yêu thích" 
            onclick="toggleWishlist(event, '{{ item.product.id }}')">
      <i class="fa-solid fa-xmark"></i>
    </button>

    {% if item.product.discount_price_vn %}
      <span class="badge-sale">Giảm giá</span>
    {% endif %}

    <a href="{% url 'products:product-detail' item.product.slug %}">
      <div class="prod-img-wrap">
        <img
          src="{% if item.product.images.first %}{{ item.product.images.first.image_url }}{% else %}{% static 'core/img/placeholder.png' %}{% endif %}"
          alt="{{ item.product.name }}"
        />
      </div>
    </a>

    <h3 class="prod-name">{{ item.product.name }}</h3>

    <div class="prod-specs-box">
        {% if item.product.is_lap %}
            <span><i class="fa-solid fa-microchip"></i> {{ item.product.laptop_config.cpu }}</span>
            <span><i class="fa-solid fa-vr-cardboard"></i> {{ item.product.laptop_config.vga }}</span>
        {% else %}
            <span><i class="fa-solid fa-copyright"></i> Brand: {{ item.product.brand }}</span>
            <span><i class="fa-solid fa-shield"></i> BH: {{ item.product.warranty }}</span>
        {% endif %}
    </div>

    <div class="prod-footer">
      <div class="price-box">
        <span class="price-current">{{ item.product.price_vn }}</span>
        {% if item.product.discount_price_vn %}
            <span class="price-old">{{ item.product.discount_price_vn }}</span>
        {% endif %}
      </div>
      <button class="btn-buy-now">Mua ngay</button>
    </div>
  </article>
{% empty %}
  <div class="empty-wishlist" style="grid-column: 1/-1; text-align: center; padding: 40px;">
    <p>Heo chưa có sản phẩm yêu thích nào ở đây cả!</p>
    <a href="{% url 'core:home' %}" class="btn-red">Đi mua sắm ngay</a>
  </div>
{% endfor %}
  <!-- DJANGO: End Loop -->
</div>
{% endblock %}
{% block extra_js %}
<script>
function toggleWishlist(event, productId) {
    event.preventDefault();
    
    // Lấy CSRF Token từ cookie của Django
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || "{{ csrf_token }}";

    // Chú ý: Dùng đúng 'orders:toggle_wishlist' vì bạn để ở app orders
    fetch("{% url 'orders:toggle_wishlist' %}", { 
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken,
        },
        body: new URLSearchParams({ 'id': productId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'removed') {
            // Xóa cái card sản phẩm ngay lập tức để user thấy đã xóa thành công
            const item = document.getElementById(`wishlist-item-${productId}`);
            if (item) {
                item.style.transition = "all 0.3s ease";
                item.style.opacity = "0";
                item.style.transform = "scale(0.8)";
                setTimeout(() => item.remove(), 300);
            }
        }
    })
    .catch(error => console.error('Lỗi rồi Heo ơi:', error));
}
</script>
{% endblock %}