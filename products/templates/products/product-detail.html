{% extends 'core/base.html' %} 
{% load static %} 

{% block title %}{{ p.name }}{% endblock %} 

{% block content %}
<div class="breadcrumb">
  <a href="{% url 'core:home' %}">Trang chủ</a> /
  <a href="{% url 'products:view-all-products' %}">Tất cả sản phẩm</a> /
  <a href="#">{{ p.brand }}</a>
</div>

<div class="detail-grid">
  <div class="gallery-box">
    <div class="main-img-wrap">
      <img
        id="mainImage"
        src="{% if p.images.first %}{{ p.images.first.image_url }}{% else %}{% static 'core/img/placeholder.png' %}{% endif %}"
        alt="{{ p.name }}"
      />
    </div>
    <div class="thumb-list">
        {% if p.images.first %}
        <div class="thumb-item active" onclick="changeImage(this, '{{ p.images.first.image_url }}')">
            <img src="{{ p.images.first.image_url }}" alt="Ảnh gốc" />
        </div>
        {% endif %}

        {% for img in p.images.all|slice:"1:" %}
        <div class="thumb-item" onclick="changeImage(this, '{{ img.image_url }}')">
            <img src="{{ img.image_url }}" alt="Ảnh phụ" />
        </div>
        {% endfor %}
    </div>
  </div>

  <div class="prod-info">
    <h1 class="prod-title">{{ p.name }}</h1>

    <div class="prod-meta">
      <div class="rating">
        <i class="fa-solid fa-star"></i> {{ p.avg_rating|default:0|floatformat:1 }} ({{ p.reviews.count }} đánh giá)
      </div>
      <div>
        Trạng thái: 
        {% if p.inventory and p.inventory.quantity > 0 %}
          <span style="color: green; font-weight: bold;">Còn hàng</span>
        {% else %}
          <span style="color: red; font-weight: bold;">Hết hàng</span>
        {% endif %}
      </div>
    </div>

    <div class="price-row">
      <span class="current-price">{{ p.price_vn }}</span>
      <span class="old-price">{{ p.discount_price_vn }}</span>
      <span class="discount-tag">-15%</span>
    </div>

    {% if p.is_lap %}
    <div class="option-group">
      <label class="option-label">Màu sắc</label>
      <div class="option-list">
        <button class="opt-btn active">Đen (Black)</button>
      </div>
    </div>

    <div class="option-group">
      <label class="option-label">Cấu hình (RAM / SSD)</label>
      <div class="option-list">
        <button class="opt-btn active">{{ p.laptop_config.ram_desc|slice:":4" }} / {{ p.laptop_config.storage_desc }}</button>
      </div>
    </div>
    {% endif %}

    <div class="promo-box">
      <div class="promo-head">
        <i class="fa-solid fa-gift"></i> Ưu đãi Lì Xì Tết
      </div>
      <ul class="promo-list">
        <li><i class="fa-solid fa-check-circle"></i> Giảm thêm 500.000đ cho Học sinh - Sinh viên.</li>
        <li><i class="fa-solid fa-check-circle"></i> Tặng Túi chống sốc cao cấp trị giá 350.000đ.</li>
        <li><i class="fa-solid fa-check-circle"></i> Giảm 20% khi mua kèm Chuột Magic Mouse.</li>
        <li><i class="fa-solid fa-check-circle"></i> Hỗ trợ cài đặt phần mềm miễn phí trọn đời.</li>
      </ul>
    </div>

    <div class="action-group">
      <button class="btn-main btn-buy" onclick="buyNow(event, '{{ p.id }}')">
        MUA NGAY
        <span>(Giao hàng tận nơi hoặc nhận tại cửa hàng)</span>
      </button>
      <button class="btn-main btn-cart {% if is_in_cart %}in-cart{% endif %}" onclick="toggleCart(event, '{{ p.id }}')">
        {% if is_in_cart %}
          <span>Đã thêm vào giỏ hàng <i class="fa-solid fa-check-circle"></i></span>
        {% else %}
          <span>Thêm vào giỏ hàng</span>
        {% endif %}
      </button>
    </div>
  </div>
</div>

<div class="content-grid">
  <div class="content-block">
    <h3 class="block-title">Đặc điểm nổi bật</h3>
    <p style="margin-bottom: 15px; color: #4b5563">
      {{ p.description }}
    </p>
    {% for img in p.images.all %}
      {% if img.image_url_feature %}
        <img
          src="{{ img.image_url_feature }}"
          style="border-radius: 12px; margin-top: 10px; max-width: 100%; height: auto;"
          alt="Đặc điểm nổi bật"
        />
      {% endif %}
    {% endfor %}
  </div>

  <div class="content-block">
    <h3 class="block-title">Thông số kỹ thuật</h3>
    
    {% if p.is_laptop %}
    <table class="specs-table">
      <tr><td>CPU</td><td>{{ p.laptop_config.cpu }}</td></tr>
      <tr><td>RAM</td><td>{{ p.laptop_config.ram_desc }}</td></tr>
      <tr><td>Ổ cứng</td><td>{{ p.laptop_config.storage_desc }}</td></tr>
      <tr><td>Màn hình</td><td>{{ p.laptop_config.screen_desc }}</td></tr>
      <tr><td>Card màn hình</td><td>{{ p.laptop_config.vga }}</td></tr>
      <tr><td>Cổng kết nối</td><td>Đầy đủ</td></tr>
      <tr><td>Pin</td><td>{{ p.laptop_config.battery }}</td></tr>
      <tr><td>Trọng lượng</td><td>{{ p.laptop_config.weight }} kg</td></tr>
      <tr><td>Led phím</td><td>Có</td></tr>
    </table>
    
    {% elif p.is_vga %}
    <table class='specs-table'>
      <tr><td>Hãng sản xuất</td><td>{{ p.brand }}</td></tr>
      <tr><td>Công nghệ</td><td>{{ p.accessory_config.detail_1 }}</td></tr>
      <tr><td>Nhân CUDA</td><td>{{ p.accessory_config.detail_2 }}</td></tr>
      <tr><td>Bộ nhớ</td><td>{{ p.accessory_config.detail_3 }}</td></tr>
      <tr><td>Xung nhịp</td><td>{{ p.accessory_config.detail_4 }}</td></tr>
      <tr><td>Kết nối</td><td>{{ p.accessory_config.detail_5 }}</td></tr>
    </table>

    {% elif p.is_cpu %}
    <table class='specs-table'>
      <tr><td>Hãng sản xuất</td><td>{{ p.brand }}</td></tr>
      <tr><td>Số nhân</td><td>{{ p.accessory_config.detail_1 }}</td></tr>
      <tr><td>Số luồng</td><td>{{ p.accessory_config.detail_2 }}</td></tr>
      <tr><td>TDP Max</td><td>{{ p.accessory_config.detail_3 }}</td></tr>
      <tr><td>Tốc độ tối đa</td><td>{{ p.accessory_config.detail_4 }}</td></tr>
      <tr><td>Xung nhịp tối đa</td><td>{{ p.accessory_config.detail_5 }}</td></tr>
    </table>

    {% elif p.is_ram %}
    <table class='specs-table'>
      <tr><td>Hãng sản xuất</td><td>{{ p.brand }}</td></tr>
      <tr><td>Dung lượng</td><td>{{ p.accessory_config.detail_1 }}</td></tr>
      <tr><td>Tốc độ</td><td>{{ p.accessory_config.detail_2 }}</td></tr>
      <tr><td>Điện áp</td><td>{{ p.accessory_config.detail_3 }}</td></tr>
      <tr><td>Loại RAM</td><td>{{ p.accessory_config.detail_4 }}</td></tr>
      <tr><td>Độ trễ</td><td>{{ p.accessory_config.detail_5 }}</td></tr>
    </table>
    {% endif %}
  </div>
</div>

<div class="content-block review-section" style="margin-bottom: 50px">
  <h3 class="block-title">Đánh giá & Nhận xét</h3>

  <div class="review-dashboard">
    <div class="rating-summary">
        <div class="average-score">
          {{ p.avg_rating|default:0|floatformat:1 }}
        </div>
        <div class="stars-display">
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star"></i>
            <i class="fa-solid fa-star-half-stroke"></i>
        </div>
        <div class="total-reviews">{{ p.reviews_set.count }} đánh giá</div>
    </div>

    <div class="review-form-box">
      {% csrf_token %}
      <h4>Viết đánh giá của bạn</h4>
      <div class="form-rating-select">
        <span>Bạn cảm thấy thế nào:</span>
        <div class="star-input">
          <i class="fa-regular fa-star" data-value="1"></i>
          <i class="fa-regular fa-star" data-value="2"></i>
          <i class="fa-regular fa-star" data-value="3"></i>
          <i class="fa-regular fa-star" data-value="4"></i>
          <i class="fa-regular fa-star" data-value="5"></i>
        </div>
      </div>
      <textarea class="review-textarea" placeholder="Mời bạn chia sẻ cảm nhận về sản phẩm..."></textarea>
      <button class="btn-submit-review">Gửi đánh giá</button>
    </div>
  </div>

  <div class="review-list">
     {% for r in reviews|slice:4 %}
     <div class="review-item">
      <div class="reviewer-info">
        <div class="avatar">
          {% if r.avatar %}
            <img src="{{ r.avatar }}" alt="{{ r.username }}">
          {% else %}
            {{ r.username|slice:":1"|upper }}
          {% endif %}
        </div>
        <div>
          <div class="reviewer-name">{{ r.full_name|default:r.username }}</div>
          <div class="review-time">{{ r.created_at|date:"d/m/Y" }}</div>
        </div>
      </div>
      <div class="review-rating">
        {% for i in "12345" %}
          {% if forloop.counter <= r.rating %}
            <i class="fa-solid fa-star"></i>
          {% else %}
            <i class="fa-regular fa-star" style="color:#e5e7eb"></i>
          {% endif %}
        {% endfor %}
      </div>
      <p class="review-text">{{ r.comment }}</p>
     </div>
     {% endfor %}
  </div>
</div>

<div class="content-block video-section" style="margin-bottom: 50px">
  <h3 class="block-title">Video đánh giá chi tiết</h3>
  <div class="video-container">
    <iframe 
        width="560" height="400" 
        src="{{ p.images.first.image_video_url }}" 
        title="YouTube video player" 
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin" 
        allowfullscreen>
    </iframe>
  </div>
</div>

<div class="mobile-bar">
  <button class="m-btn m-add {% if is_in_cart %}in-cart{% endif %}" onclick="toggleCart(event, '{{ p.id }}')">
    {% if is_in_cart %}
      <i class="fa-solid fa-check"></i> Đã có trong giỏ
    {% else %}
      <i class="fa-solid fa-cart-plus"></i> Thêm vào giỏ
    {% endif %}
  </button>
  <button class="m-btn m-buy" onclick="buyNow(event, '{{ p.id }}')">
    Mua Ngay
  </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const starInputContainer = document.querySelector('.star-input');
    const stars = starInputContainer.querySelectorAll('i');
    const reviewTextarea = document.querySelector('.review-textarea');
    const submitBtn = document.querySelector('.btn-submit-review');
    const reviewListContainer = document.querySelector('.review-list'); 
    
    let currentRating = 0;

    // Hàm helper để cập nhật giao diện sao
    function updateStars(rating) {
        stars.forEach(s => {
            const sValue = s.getAttribute('data-value');
            if (sValue <= rating) {
                s.classList.replace('fa-regular', 'fa-solid'); 
                s.style.color = '#f5b301'; 
            } else {
                s.classList.replace('fa-solid', 'fa-regular'); 
                s.style.color = '#ccc';
            }
        });
    }

    // Logic xử lý sao
    stars.forEach(star => {
        // Khi di chuột vào một sao
        star.addEventListener('mouseover', function() {
            const hoverRating = this.getAttribute('data-value');
            updateStars(hoverRating);
        });

        // Khi click để chốt rating
        star.addEventListener('click', function() {
            currentRating = this.getAttribute('data-value');
            updateStars(currentRating); // Cập nhật lại để giữ màu sau khi click
        });
    });

    // Khi di chuột ra khỏi toàn bộ khu vực sao, trả về trạng thái đã click
    starInputContainer.addEventListener('mouseout', function() {
        updateStars(currentRating);
    });

    //  Logic gửi đánh giá
    submitBtn.addEventListener('click', function(e) {
        e.preventDefault();

        const contentValue = reviewTextarea.value.trim();

        if (currentRating === 0) {
            Swal.fire('Chưa hợp lệ', 'Vui lòng chọn số sao đánh giá!', 'warning');
            return;
        }
        if (contentValue === "") {
            Swal.fire('Chưa hợp lệ', 'Vui lòng nhập nội dung bình luận!', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('rating', currentRating);
        formData.append('content', contentValue);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: 'Cảm ơn bạn đã gửi đánh giá về sản phẩm.',
                    timer: 2000,
                    showConfirmButton: false
                });


                const avatarHTML = data.avatar 
                    ? `<img src="${data.avatar}" alt="${data.username}">` 
                    : `<div class="avatar-placeholder" style="width:40px;height:40px;background:#eee;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;">${data.username.charAt(0).toUpperCase()}</div>`;

                let starsHTML = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= data.rating) {
                        starsHTML += '<i class="fa-solid fa-star"></i>';
                    } else {
                        starsHTML += '<i class="fa-regular fa-star" style="color:#e5e7eb"></i>';
                    }
                }

                const newReviewHTML = `
                    <div class="review-item" style="animation: fadeIn 0.5s; border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 10px;">
                        <div class="reviewer-info" style="display:flex; gap:10px; align-items:center;">
                            <div class="avatar" style="width:40px;height:40px;border-radius:50%;overflow:hidden;display:flex;justify-content:center;align-items:center;">${avatarHTML}</div>
                            <div>
                                <div class="reviewer-name" style="font-weight:bold;">${data.full_name}</div>
                                <div class="review-time" style="font-size:12px; color:#888;">Vừa xong</div>
                            </div>
                        </div>
                        <div class="review-rating" style="margin: 5px 0;">${starsHTML}</div>
                        <p class="review-text">${data.comment}</p>
                    </div>`;

                // Chèn lên đầu danh sách
                reviewListContainer.insertAdjacentHTML('afterbegin', newReviewHTML);

                // Ẩn dòng thông báo rỗng
                const noReviewMsg = reviewListContainer.querySelector('p');
                if (noReviewMsg && noReviewMsg.textContent.includes("chưa có đánh giá")) {
                    noReviewMsg.remove();
                }

                // Reset form
                reviewTextarea.value = '';
                currentRating = 0;
                stars.forEach(s => {
                    s.classList.replace('fa-solid', 'fa-regular');
                    s.style.color = '#ccc';
                });

            } else {
                Swal.fire('Lỗi', data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Lỗi hệ thống:', error);
            Swal.fire('Lỗi hệ thống', 'Có lỗi xảy ra khi gửi bình luận.', 'error');
        });
    });
});

function toggleCart(event, productId) {
    event.preventDefault();
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || "{{ csrf_token }}";
    const cartButton = event.currentTarget; // Lấy chính nút đã được click

    fetch("{% url 'products:toggle_cart' %}", { 
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken,
        },
        body: new URLSearchParams({ 'id': productId })
    })
    .then(response => {
        if (!response.ok) throw new Error("Lỗi Server (500)");
        return response.json();
    })
    .then(data => {
        if (data.status === 'login_required') {
            Swal.fire({
                icon: 'warning',
                title: 'Yêu cầu đăng nhập',
                text: data.message,
                confirmButtonText: 'Đăng nhập ngay'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{% url 'users:login' %}?next=" + window.location.pathname;
                }
            });
        } else {
            // Cập nhật giao diện nút mà không cần reload
            if (data.status === 'added') {
                cartButton.classList.add('in-cart');
                // Chỉ cập nhật nút trên desktop nếu nó được click
                if (cartButton.classList.contains('btn-main')) {
                    cartButton.innerHTML = `<span>Đã thêm vào giỏ hàng <i class="fa-solid fa-check-circle"></i></span>`;
                }
            } else if (data.status === 'removed') {
                cartButton.classList.remove('in-cart');
                if (cartButton.classList.contains('btn-main')) {
                    cartButton.innerHTML = `<span>Thêm vào giỏ hàng</span>`;
                }
            }

            // Cập nhật nút trên thanh mobile nếu có
            updateMobileCartButton(data.status);

            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: data.status === 'added' ? 'success' : 'info',
                title: data.message,
                showConfirmButton: false,
                timer: 2500
            });
        }
    })
    .catch(error => {
        console.error('Lỗi:', error);
        Swal.fire('Lỗi', 'Không thể thêm vào giỏ hàng lúc này.', 'error');
    });
}

function updateMobileCartButton(status) {
    const mobileButton = document.querySelector('.mobile-bar .m-btn.m-add');
    if (!mobileButton) return;

    if (status === 'added') {
        mobileButton.classList.add('in-cart');
        mobileButton.innerHTML = `<i class="fa-solid fa-check"></i> Đã có trong giỏ`;
    } else if (status === 'removed') {
        mobileButton.classList.remove('in-cart');
        mobileButton.innerHTML = `<i class="fa-solid fa-cart-plus"></i> Thêm vào giỏ`;
    }
}

function buyNow(event, productId) {
    event.preventDefault();
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || "{{ csrf_token }}";

    fetch("{% url 'products:toggle_cart' %}", { 
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken,
        },
        // Gửi thêm action='add_only' để backend biết chỉ thêm, không xóa
        body: new URLSearchParams({ 'id': productId, 'action': 'add_only' })
    })
    .then(response => {
        if (!response.ok) throw new Error("Lỗi Server");
        return response.json();
    })
    .then(data => {
        if (data.status === 'login_required') {
            Swal.fire('Yêu cầu đăng nhập', data.message, 'warning').then(() => {
                window.location.href = "{% url 'users:login' %}?next=" + window.location.pathname;
            });
        } else {
            // Dù thêm mới hay đã có sẵn, đều chuyển đến trang giỏ hàng
            window.location.href = "{% url 'orders:cart' %}";
        }
    })
    .catch(error => {
        console.error('Lỗi khi thực hiện Mua Ngay:', error);
        Swal.fire('Lỗi', 'Không thể thực hiện thao tác này.', 'error');
    });
}

function changeImage(element, imageUrl) {
    document.getElementById('mainImage').src = imageUrl;
    
    // Xóa active ở tất cả thumb
    document.querySelectorAll('.thumb-item').forEach(item => item.classList.remove('active'));
    
    // Thêm active cho thumb được click
    element.classList.add('active');
}
</script>

<style>
  .btn-main {
    font-size: 14px; /* Giảm kích thước chữ chính */
    padding: 14px 20px; /* Điều chỉnh padding cho cân đối */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.3;
  }

  .btn-main span {
    font-size: 11px; /* Giảm kích thước chữ phụ */
    font-weight: 400;
    opacity: 0.9;
    display: block;
    margin-top: 2px;
  }

  .btn-cart > span {
    font-size: 14px; /* Đảm bảo chữ trong nút giỏ hàng đồng bộ */
    font-weight: 700; /* Đặt font-weight cố định */
  }

  .btn-cart.in-cart .fa-check-circle {
    color: #22c540; /* Màu xanh lá cây */
  }
</style>
{% endblock %}