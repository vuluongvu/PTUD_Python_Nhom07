{% extends 'core/base.html' %} 
{% load static %} {% load product_tags %} {% block title %}
Kết quả tìm kiếm - LapStore
{% endblock %} {% block content %}
<div style="margin-top: -10px; margin-bottom: 20px">
  <p style="font-size: 13px; color: var(--text-sub)">
    <a href="{% url 'core:home' %}">Trang chủ</a>
    <i
      class="fa-solid fa-chevron-right"
      style="font-size: 10px; margin: 0 5px"
    ></i>
    Kết quả tìm kiếm
  </p>
</div>

<!-- Header kết quả -->
<div class="search-header-block">
  <div class="search-title">
    <!-- DJANGO: Hiển thị query tìm kiếm và số lượng kết quả -->
    <h1>Kết quả tìm kiếm cho: "{{ query }}"</h1>
    <span class="search-count"
      >Tìm thấy {{ page_obj.paginator.count }} sản phẩm phù hợp</span
    >
  </div>

  <!-- Bộ lọc nhanh -->
  <div class="filter-bar">
    <a href="?{% url_replace sort='default' %}" class="filter-btn {% if not sort_param or sort_param == 'default' %}active{% endif %}">
      <i class="fa-solid fa-sort"></i> Mặc định
    </a>
    <a href="?{% url_replace sort='price_asc' %}" class="filter-btn {% if sort_param == 'price_asc' %}active{% endif %}">
      <i class="fa-solid fa-arrow-up-1-9"></i> Giá thấp - cao
    </a>
    <a href="?{% url_replace sort='price_desc' %}" class="filter-btn {% if sort_param == 'price_desc' %}active{% endif %}">
      <i class="fa-solid fa-arrow-down-9-1"></i> Giá cao - thấp
    </a>
  </div>
</div>

<!-- Lưới sản phẩm -->
<div class="flash-grid" style="margin-bottom: 40px">
  <!-- DJANGO -->
  
   {% for p in products %}
         <a href="{% url 'products:product-detail' p.slug %}">
            <article class="prod-card prod-card-view-all">
              <button class="btn-add-wishlist" 
                      title="Thêm vào yêu thích" 
                      onclick="toggleWishlist(event, '{{ p.id }}')">
                <i id="heart-{{ p.id }}" 
                   class="fa-heart {% if p.id in wishlist_ids %}fa-solid text-danger{% else %}fa-regular{% endif %}">
                </i>
              </button>
              <span class="badge-sale">Hot</span>
              <div class="prod-img-wrap">
                <img src="{% if p.images.first %}{{ p.images.first.image_url }}{% else %}{% static 'core/img/placeholder.png' %}{% endif %}" alt="{{ p.name }}" />
              </div>
              <h3 class="prod-name">{{p.name}}</h3>
              <div class="prod-specs-box">
                {% if p.is_laptop %}
                <span
                  ><i class="fa-solid fa-vr-cardboard"></i>VGA: {{p.laptop_config.vga}}
                  </span
                >
                <span><i class="fa-solid fa-microchip"></i>CPU: {{p.laptop_config.cpu}}</span>
                {% else %}
                <span
                  ><i class="fa-regular fa-copyright"></i>Brand: {{p.brand}}
                  </span
                >
                <span><i class="fa-solid fa-shield"></i>Bảo hành: {{p.warranty}}</span>
                {% endif %}
              </div>
              <div class="prod-footer">
                <div class="price-box">
                  {% if p.discount_price and p.discount_price < p.price %}
                    <span class="price-current">{{ p.discount_price_vn }}</span>
                    <span class="price-old">{{ p.price_vn }}</span>
                  {% else %}
                    <span class="price-current">{{ p.price_vn }}</span>
                  {% endif %}
                </div>
                <button class="btn-buy-now" onclick="toggleCart(event, '{{ p.id }}')">Mua ngay</button>
              </div>
            </article>
          </a>
           {% endfor %}
 
  <!-- DJANGO -->
</div>

<!-- Phân trang -->
<div class="pagination">
  {% if page_obj.has_previous %}
  <a href="?{% url_replace page=page_obj.previous_page_number %}" class="page-link">
    <i class="fa-solid fa-chevron-left"></i>
  </a>
  {% endif %} {% for num in page_obj.paginator.page_range %} {% if page_obj.number == num %}
  <a href="#" class="page-link active">{{ num }}</a>
  {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
  <a href="?{% url_replace page=num %}" class="page-link">{{ num }}</a>
  {% endif %} {% endfor %} {% if page_obj.has_next %}
  <a href="?{% url_replace page=page_obj.next_page_number %}" class="page-link">
    <i class="fa-solid fa-chevron-right"></i>
  </a>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleWishlist(event, productId) {
    event.preventDefault();
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || "{{ csrf_token }}";

    fetch("{% url 'core:toggle_wishlist' %}", { 
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken,
        },
        body: new URLSearchParams({ 'id': productId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'login_required') {
            Swal.fire({
                icon: 'warning',
                title: 'Yêu cầu đăng nhập',
                text: data.message,
                confirmButtonText: 'Đăng nhập ngay'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{% url 'users:login' %}?next=" + window.location.pathname + window.location.search;
                }
            });
            return;
        }
        
        Swal.fire({
            toast: true, position: 'top-end', icon: 'success',
            title: data.message, showConfirmButton: false,
            timer: 2000
        });

        const heartIcon = document.getElementById(`heart-${productId}`);
        if (data.status === 'added') {
            heartIcon.classList.remove('fa-regular');
            heartIcon.classList.add('fa-solid', 'text-danger');
        } else if (data.status === 'removed') {
            heartIcon.classList.remove('fa-solid', 'text-danger');
            heartIcon.classList.add('fa-regular');
        }
    });
}

function toggleCart(event, productId) {
    event.preventDefault();
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || "{{ csrf_token }}";

    fetch("{% url 'products:toggle_cart' %}", { 
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": csrftoken,
        },
        body: new URLSearchParams({ 'id': productId, 'action': 'add_only' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'login_required') {
            Swal.fire('Yêu cầu đăng nhập', data.message, 'warning').then(() => {
                window.location.href = "{% url 'users:login' %}?next=" + window.location.pathname + window.location.search;
            });
        } else {
            window.location.href = "{% url 'orders:cart' %}";
        }
    });
}
</script>
{% endblock %}
